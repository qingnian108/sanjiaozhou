# 三角洲员工系统 - 服务器部署教程

## 服务器信息

- **服务器 IP**: `101.43.70.216`
- **SSH 密码**: `yang108879+`
- **后端端口**: `3000`
- **前端目录**: `/www/wwwroot/sanjiaozhou/`
- **后端目录**: `/www/wwwroot/sanjiaozhou-api/`
- **PM2 进程名**: `sanjiaozhou-api`
- **MongoDB 数据库**: `sanjiaozhou`
- **超级管理员**: `nolan` / `yang108879+`

---

## 一、快速部署命令

### 前端部署
```bash
# 1. 本地构建
npm run build

# 2. 上传到服务器
scp -r dist/* root@101.43.70.216:/www/wwwroot/sanjiaozhou/
```

### 后端部署
```bash
# 1. 上传后端代码
scp server/index.js root@101.43.70.216:/www/wwwroot/sanjiaozhou-api/

# 2. 重启服务
ssh root@101.43.70.216 "pm2 restart sanjiaozhou-api"
```

### 查看日志
```bash
ssh root@101.43.70.216 "pm2 logs sanjiaozhou-api --lines 100"
```

---

## 二、MongoDB 数据库操作

### 连接数据库
```bash
ssh root@101.43.70.216 "mongosh sanjiaozhou"
```

### 常用查询命令
```javascript
// 查看所有集合
show collections

// 查看用户
db.users.find().pretty()

// 查看租户账户
db.tenantaccounts.find().pretty()

// 查看通用数据（云机、窗口、订单等）
db.datas.find({collection: 'cloudMachines'}).pretty()
db.datas.find({collection: 'cloudWindows'}).pretty()
db.datas.find({collection: 'orders'}).pretty()
db.datas.find({collection: 'purchases'}).pretty()

// 按租户查询
db.datas.find({collection: 'cloudMachines', tenantId: '租户ID'}).pretty()

// 查看好友关系
db.friends.find().pretty()

// 查看转让记录
db.transfers.find().pretty()
db.machinetransfers.find().pretty()
```

### 执行脚本
```bash
# 上传脚本
scp script.js root@101.43.70.216:/tmp/

# 执行脚本
ssh root@101.43.70.216 "mongosh sanjiaozhou /tmp/script.js"
```

---

## 三、数据库集合说明

| 集合名 | 说明 |
|--------|------|
| `users` | 用户账号（老板、员工、客服） |
| `tenantaccounts` | 租户账户（余额、有效期、邀请码） |
| `windowsubscriptions` | 窗口订阅 |
| `purchaserecords` | 购买记录（基础月费、窗口） |
| `rechargeorders` | 充值订单 |
| `rechargerecords` | 充值记录 |
| `referrals` | 邀请关系 |
| `commissions` | 返佣记录 |
| `friends` | 好友关系 |
| `transfers` | 窗口转让 |
| `machinetransfers` | 云机转让 |
| `datas` | 通用数据（云机、窗口、订单、采购等） |

### datas 集合的 collection 字段值
- `cloudMachines` - 云机
- `cloudWindows` - 窗口
- `orders` - 订单
- `purchases` - 采购记录
- `settings` - 租户设置
- `kookChannels` - Kook 频道

---

## 四、API 接口文档

### 基础信息
- **Base URL**: `https://jdj.9vvn.com/api` 或 `http://101.43.70.216:3000/api`
- **Content-Type**: `application/json`

### 用户认证

#### 注册
```http
POST /api/register
{
  "username": "用户名",
  "password": "密码",
  "inviteCode": "邀请码（可选）"
}
```

#### 登录
```http
POST /api/login
{
  "username": "用户名",
  "password": "密码"
}
```

#### 修改密码
```http
POST /api/change-password
{
  "username": "用户名",
  "oldPassword": "旧密码",
  "newPassword": "新密码"
}
```

### 通用数据 CRUD

#### 获取数据
```http
GET /api/data/:collection/:tenantId
```

#### 添加数据
```http
POST /api/data/:collection
{
  "tenantId": "租户ID",
  ...其他字段
}
```

#### 更新数据
```http
PUT /api/data/:collection/:id
{
  ...更新字段
}
```

#### 删除数据
```http
DELETE /api/data/:collection/:id
```

### 账户相关

#### 获取账户信息
```http
GET /api/account/:tenantId
```

#### 购买基础月费
```http
POST /api/account/:tenantId/buy-base
{
  "months": 1
}
```

#### 购买窗口
```http
POST /api/account/:tenantId/buy-windows
{
  "count": 5,
  "months": 1
}
```

### 好友系统

#### 搜索用户
```http
GET /api/search-user/:username
```

#### 发送好友请求
```http
POST /api/friend/request
{
  "fromId": "发起者tenantId",
  "fromName": "发起者名称",
  "toId": "接收者tenantId",
  "toName": "接收者名称"
}
```

#### 获取好友列表
```http
GET /api/friends/:tenantId
```

### 转让系统

#### 发起窗口转让
```http
POST /api/transfer/request
{
  "fromTenantId": "转出方",
  "toTenantId": "接收方",
  "windowId": "窗口ID",
  "windowInfo": {...}
}
```

#### 发起云机转让
```http
POST /api/machine-transfer/request
{
  "fromTenantId": "转出方",
  "toTenantId": "接收方",
  "machineId": "云机ID",
  "machineInfo": {...},
  "windowIds": ["窗口ID列表"],
  "windowsInfo": [...],
  "price": 100,
  "totalGold": 10000000
}
```

### 邀请返佣

#### 验证邀请码
```http
GET /api/referral/validate/:inviteCode
```

#### 获取邀请信息
```http
GET /api/referral/:tenantId
```

#### 获取被邀请人列表
```http
GET /api/referral/:tenantId/invitees
```

#### 获取返佣记录
```http
GET /api/referral/:tenantId/commissions
```

### 超级管理员

#### 超管登录
```http
POST /api/super/login
{
  "username": "nolan",
  "password": "密码"
}
```

#### 获取所有租户
```http
GET /api/super/tenants
```

#### 手动充值
```http
POST /api/super/recharge
{
  "tenantId": "租户ID",
  "amount": 100,
  "note": "备注"
}
```

#### 设置返佣比例
```http
POST /api/super/set-commission-rate
{
  "tenantId": "租户ID",
  "rate": 0.15
}
```

---

## 五、微信支付配置

### 环境变量 (.env)
```env
WECHAT_MCHID=商户号
WECHAT_APPID=应用ID
WECHAT_API_V3_KEY=APIv3密钥
WECHAT_CERT_SERIAL=证书序列号
WECHAT_NOTIFY_URL=https://jdj.9vvn.com/api/wechat/notify
```

### 证书文件
将微信支付证书放在后端目录：
- `/www/wwwroot/sanjiaozhou-api/apiclient_key.pem` - 私钥文件

### 支付流程
1. 前端调用 `/api/recharge/create` 创建充值订单
2. 后端调用微信支付 Native 下单接口，返回二维码链接
3. 用户扫码支付
4. 微信回调 `/api/wechat/notify`
5. 后端验证签名，更新订单状态，增加账户余额
6. 如有邀请人，自动计算并发放返佣

---

## 六、用户角色说明

| 角色 | 说明 | 权限 |
|------|------|------|
| `super` | 超级管理员 | 管理所有租户、手动充值、设置返佣比例 |
| `admin` | 老板 | 完整的租户管理权限 |
| `staff` | 员工 | 执行订单、查看分配的窗口 |
| `dispatcher` | 客服 | 派单、管理窗口分配，无财务权限 |

### 客服权限限制
- ✅ 可以访问：派单、云机管理、云机采购、窗口申请、员工列表、Kook
- ❌ 不能访问：总览统计（利润/库存/成本）、账户页面、好友页面、采购记录

---

## 七、计费模式

### 预付费模式
1. **基础月费**: 50元/月（账户有效期）
2. **窗口费用**: 10元/窗口/月
3. **试用期**: 新注册用户 7 天免费试用

### 邀请返佣
- 默认返佣比例: 10%
- 被邀请人充值时，邀请人获得返佣
- 返佣直接加到邀请人账户余额

---

## 八、常见问题

### Q: 云机转让后消失了？
检查转让逻辑是否正确创建了新的云机记录。运行调试脚本：
```bash
mongosh sanjiaozhou /tmp/debug_machine_transfer.js
```

### Q: 利润计算不对？
利润计算公式：
```
avgCost = totalCost / (totalAmount / 10000000)  // 元/千万
revenue = (order.amount / 1000) * order.unitPrice
cogs = ((order.amount + lossInWan) / 1000) * avgCost
laborCost = (order.amount / 1000) * settings.employeeCostRate
profit = revenue - cogs - laborCost
```
默认 `employeeCostRate = 12`

### Q: 如何重启服务？
```bash
ssh root@101.43.70.216 "pm2 restart sanjiaozhou-api"
```

### Q: 如何查看错误日志？
```bash
ssh root@101.43.70.216 "pm2 logs sanjiaozhou-api --err --lines 50"
```
